<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="../assets/css/martech-min.css">

  <title>MarTech | Shadow DOM Click Tracking</title>

  <meta name="Author" content="Todd Croak-Falen">
  <meta name="Description" content="MarTech shadow DOM click tracking.">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../favicon.ico">
  <meta name="msapplication-config" content="browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

</head>

<body class="body">

  <div class="body__project-container">

    <h1>Shadow DOM Click Tracking</h1>

    <h2>Shadow DOM Data Element (‘shadow doms’)</h2>

    <p>First, create a data element called 'shadow doms'. Select 'Custom Code'. Then paste in this snippet:</p>

    <pre><code>
        return [...document.getElementsByTagName('*')].filter(tag => !!tag.shadowRoot);
    </pre></code>

    <p>That's all the code you need for the data element!</p>

    <h3>Explanation</h3>

    <ol>
      <li><p><code>document.getElementsByTagName('*')</code> gets all tags on the page.</p></li>
      <li><p>However, that returns an HTMLCollection. Convert it to an array by wrapping it inside <code>[...]</code>.</p></li>
      <li><p>Now that you have an array, you can call the <code>.filter</code> method on it.</p></li>
      <li><p>Inside the <code>.filter</code> method, <code>(tag => !!tag.shadowRoot)</code> checks each tag in the array. If a tag contains <code>shadowRoot</code>, then that tag represents a shadow DOM, and the filter will include it. (If not, the filter will ignore that tag.)</p></li>
      <li><p><code>return</code> all of this because your data element needs to return a value. You now have a new array made up only of the shadow DOM tags that were filtered out of the entire page. (If none were found, it will return an empty array.)</p></li>
    </ol>

    <h3>How to Use the <b>shadow doms</b> Data Element</h3>

    Executing <b>_satellite.getVar('shadow doms');</b> will return an array containing all shadow DOMs found on the page. (If none are found, it will return an empty array.)

    <h2>Shadow DOM “Add Event Listener” Rule</h2>

  <pre><code>
        const shadowDOMs = _satellite.getVar('shadow doms');
        
        const shadowClicks = (e) => {
          const clickData = {
            shadowClick: true,
            clickedElement: '',
          }
          
          if (!!e.target) {
            if (e.target instanceof SVGElement) {
              if (!!e.target.getAttribute('d')) {
                clickData.clickedElement = e.target.parentNode.parentNode; // Handles clicks on path elements *inside* SVG tags -- has to go up two levels. This condition must be nested *inside the "instanceof SVGElement" condition*, as that will also be true.
              } else {
                clickData.clickedElement = e.target.parentNode; // Handles clicks on SVG tags.
              }
            } else {
              clickData.clickedElement = e.target; // All other clicks (non-SVG).
            }
          }
          
          if (!!clickData) {
            _satellite.track('set-global-click-or-event-variables', clickData);
            _satellite.track('send-global-click-or-event-beacon');
          }
        }
        
        if (!!shadowDOMs && Array.isArray(shadowDOMs) && shadowDOMs.length > 0) {
          shadowDOMs.forEach((shadowDOM) => {
            shadowDOM.shadowRoot.addEventListener('click', shadowClicks);
          });
        }
      </pre></code>

  </div>

</body>

</html>