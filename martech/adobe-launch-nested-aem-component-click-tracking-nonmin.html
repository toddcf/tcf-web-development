<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Headings -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <!-- Body -->
  <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="../assets/prism/prism-okaidia-1.29.0.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/global-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/text-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/nav-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/headings-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/martech-article.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/footer-min.css">
  
  <title>MarTech | Adobe Launch Nested AEM Component Click Tracking</title>

  <meta name="Author" content="Todd Croak-Falen">
  <meta name="Description" content="MarTech Adobe Launch Nested AEM Component Click Tracking.">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../favicon.ico">
  <meta name="msapplication-config" content="browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

</head>

<body class="body line-numbers">

  <div class="body__project-container">

    <nav class="nav">
      <div class="content__center content__center_1140 nav__flex">
        <a href="/" class="nav__flex_link font_size_1">
          <div class="nav__flex_text"><i class="fas fa-home nav__flex_icon"></i>Home</div>
        </a>
        <a href="../about-me" class="nav__flex_link font_size_1">
          <div class="nav__flex_text"><i class="fas fa-user-circle nav__flex_icon"></i>About Me</div>
        </a>
        <!-- <a href="../resume_todd_croak-falen.pdf" target="_blank" class="nav__flex_link font_size_1">
          <div class="nav__flex_text"><i class="fas fa-file-alt nav__flex_icon"></i>Résumé</div>
        </a> -->
      </div> <!-- Close .nav__flex -->
    </nav>

    <main class="main content-top">

      <header class="header">
        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h1 class="heading__title-tag font_size_4">
              <span class="heading__title-tag_title">Adobe Launch Nested AEM Component Click Tracking</span>
            </h1>
          </div>
        </div>
        <div class="martech-header__img martech-header__img_waterfall-cascade"></div>
      </header>

      <section>

        <div class="heading heading_theme_black">
          <div class="heading__title-overflow">
            <h2 class="heading__title-tag font_size_3">
              <span class="heading__title-tag_title">Overview</span>
            </h2>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">
          
            <p class="main__text font_size_body">When my company began using AEM Components, it was the MarTech team&rsquo;s job to implement click tracking on those components. We already had global click tracking in place that would take the <code class="code__name">data-track-noun</code> and <code class="code__name">data-track-verb</code> attributes, concatenate them, and delimit them with a colon. But this was going to require additional complexity.</p>

            <p class="main__text font_size_body">For starters, the AEM Components were going to be nested inside each other. There could be several layers of nesting. And when a component was clicked, we were going to want to concatenate the click tracking values of the parent components all the way down to the child that was clicked.</p>
            
            <p class="main__text font_size_body">For example, the Careers page has three sections:</p>

            <ol class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">Employment</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Apprenticeships</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Internships</p>
              </li>
            </ol>

            <p class="main__text font_size_body">Within each of these sections there is a set of cards, each representing a category. For example, the &ldquo;Employment&rdquo; section contains these cards:</p>

            <ul class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">Administration</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Research & Development</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Sales</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Installation & Repair</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Support</p>
              </li>
            </ul>

            <p class="main__text font_size_body">And each card contains two buttons:</p>

            <ul class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">Learn More</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">View Jobs</p>
              </li>
            </ul>

            <p class="main__text font_size_body">If a user clicks a &ldquo;Learn More&rdquo; button and all I pass is <code class="code__name">learn-more</code>, that won&rsquo;t tell our analysts much about which careers are getting the most clicks. Instead, they want values like:</p>

            <ul class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">employment:research-development:learn-more</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">employment:installation-repair:view-jobs</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">employment:administration:learn-more</p>
              </li>
            </ul>

            <p class="main__text font_size_body">This was going to require more than just the standard two <code class="code__name">data-track-noun</code> and <code class="code__name">data-track-verb</code> attributes.</p>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h3 class="heading__title-tag font_size_2">
              <span class="heading__title-tag_title">Solution</span>
            </h3>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <p class="main__text font_size_body">I decided that we could add a <code class="code__snippet">data-track-component-level-X</code> attribute, with <code class="code__snippet">X</code> being a number. (These would have to be set dynamically, because we would never know how many levels a given component was going to be nested.)</p>

            <ul class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">data-track-component-level-1="employment"</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">data-track-noun="research-development"</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">data-track-verb="learn-more"</p>
              </li>
            </ul>

            <p class="main__text font_size_body">The three (or more) of those would then be concatenated, in the correct order, and only if they exist. Since there could be multiple levels of parent components, we could potentially wind up with <code class="code__name">data-track-component-level-1</code>, <code class="code__name">2</code>, <code class="code__name">3</code>, etc.</p>

            <p class="main__text font_size_body">The question was how to add these attributes to each AEM Component. Our Content team did not have the bandwidth to add each one manually. Furthermore, AEM Components might be nested in a multitude of ways, and those ways might be changed on the fly. If each such change involved the complete reauthoring of every AEM Component&rsquo;s tracking attributes, the scope of each change would become unwieldy, and the opportunity for mistakes would increase.</p>

            <p class="main__text font_size_body">Therefore, it was decided that these values would be set programmatically. We came up with a two-pronged approach. The first prong was on the AEM side, which would be handled by the Content team:</p>

            <ul class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">Each AEM Component would be given a <code class="code__snippet">data-track-component-type</code> attribute. Its value would represent the type of component: <code class="code__snippet">header</code>, <code class="code__snippet">footer</code>, <code class="code__snippet">breadcrumb</code>, <code class="code__snippet">crowdriff</code>, etc. (This is so we will know which elements to treat as AEM Components.)</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Values from heading tags, link text, etc. are programmatically copied into <code class="code__snippet">data-track-verb</code> attributes.</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Each of these values would get programmatically standardized into lowercase kebab-case.</p>
              </li>
            </ul>

            <p class="main__text font_size_body">The second prong would be handled by the MarTech team, via Adobe Launch:</p>

            <ol class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body">On each page/route load, an Adobe Launch rule would fire that would crawl the page. If it found any elements containing a <code class="code__snippet">data-track-component-type</code> attribute, it would collect its tracking attributes.</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Then it would check the next layer of children for that element. If any contained a <code class="code__snippet">data-track-component-type</code> attribute, the tracking attributes from the parent element would be added to the tracking attributes of the child element using the <code class="code__snippet">data-track-component-level-X</code> attribute.</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">The process would repeat for the children of that child, until no more children were found. Depending on how many layers of nesting there were for the AEM Components, this is where we might wind up with <code class="code__snippet">data-track-component-level-1</code>, <code class="code__snippet">data-track-component-level-2</code>, <code class="code__snippet">data-track-component-level-3</code>, etc.</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body">Once an element has been modified, the Launch rule would set a flag on it so we know it's been handled. That way, if more AEM Components got added to the page after the initial page load and our rule needed to crawl the page again, it could skip modifying the components it already modified in the previous pass.</p>
              </li>
            </ol>

            <p class="main__text font_size_body">Then, the MarTech team would have to modify the <code class="code__name">Global | Set Variables | Clicks or Events #25</code> rule. Currently, that rule only checked for <code class="code__snippet">data-track-noun</code> and <code class="code__snippet">data-track-verb</code> and concatenated the two. Now it would have to factor in any number of <code class="code__snippet">data-track-component-level-X</code> attributes at the beginning of that concatenation. (For an explanation on how that was accomplished, see my article on <a class="link link_theme_black" href="adobe-launch-global-clicks-or-events-tracking">Adobe Launch Global Clicks or Events Tracking</a>.)</p>

            <p class="main__text font_size_body">But to see how the programming was done for the AEM Component attributes, keep reading.</p>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->
        
      </section>

      <section>

        <div class="heading heading_theme_black">
          <div class="heading__title-overflow">
            <h2 class="heading__title-tag font_size_3">
              <span class="heading__title-tag_title">&lsquo;Global | Set AEM Component Data Attributes&rsquo; Rule</span>
            </h2>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <p class="main__text font_size_body">We created an Adobe Launch rule named <code class="code__name">Global | Set AEM Component Data Attributes</code>. Here&rsquo;s the full syntax for context. (Scroll past it for an explanation on how each part works.)</p>
          
          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

        <div class="content__center content__center_1440">

          <div class="content__block">

  <pre class="code__block"><code class="language-javascript">const aemComponentTracking = {
  setTrackingAttributes: (currentElement, mergedTrackingAttributesArr) => {
    mergedTrackingAttributesArr = (!!mergedTrackingAttributesArr && Array.isArray(mergedTrackingAttributesArr)) ? mergedTrackingAttributesArr : [];

    const numberOfValues = mergedTrackingAttributesArr.length;
    if (!!currentElement && numberOfValues > 0) {
      if (numberOfValues === 1) {
        currentElement.removeAttribute('data-track-noun');
      }

      mergedTrackingAttributesArr.forEach((trackingAttribute, i) => {
        switch (i) {
          case numberOfValues - 1:
            currentElement.setAttribute('data-track-verb', trackingAttribute);
            break;
          case numberOfValues - 2:
            currentElement.setAttribute('data-track-noun', trackingAttribute);
            break;
          default:
            currentElement.setAttribute(`data-track-component-level-${i + 1}`, trackingAttribute);
        }
      });
      currentElement.setAttribute('data-track-component-attributes-set', 'true');
    }
    aemComponentTracking.checkChildren(currentElement, mergedTrackingAttributesArr);
  },
  uniqueValue(arr, str) {
    let unique = true;
    if (!!arr && Array.isArray(arr) && arr.length > 0 && !!str && arr.includes(str)) {
      unique = false;
    }
    return unique;
  },
  mergeTrackingAttributes: (currentElement, existingTrackingAttributes, parentTrackingAttributes) => {
    existingTrackingAttributes = (!!existingTrackingAttributes && Array.isArray(existingTrackingAttributes)) ? existingTrackingAttributes : [];
    parentTrackingAttributes = (!!parentTrackingAttributes && Array.isArray(parentTrackingAttributes)) ? parentTrackingAttributes : [];
    mergedTrackingAttributesArr = [];

    const mergedTrackingAttributesArrPusher = (arr) => {
      if (!!arr && Array.isArray(arr) && arr.length > 0) {
        arr.forEach(arrItem => {
          if (aemComponentTracking.uniqueValue(mergedTrackingAttributesArr, arrItem)) {
            mergedTrackingAttributesArr.push(arrItem);
          }
        });
      }
    }

    mergedTrackingAttributesArrPusher(parentTrackingAttributes);
    mergedTrackingAttributesArrPusher(existingTrackingAttributes);

    aemComponentTracking.setTrackingAttributes(currentElement, mergedTrackingAttributesArr);
  },
  getTrackingAttributes: (currentElement, parentTrackingAttributes) => {
    parentTrackingAttributes = (!!parentTrackingAttributes && Array.isArray(parentTrackingAttributes)) ? parentTrackingAttributes : [];
    const existingTrackingAttributes = [];

    let level = 1;
    let parentComponentLevelX = '';
    do {
      parentComponentLevelX = currentElement.getAttribute(`data-track-component-level-${level}`);
      if (!!parentComponentLevelX) {
        existingTrackingAttributes.push(parentComponentLevelX);
      }
      level++;
    } while (!!currentElement.getAttribute(`data-track-component-level-${level}`));

    const dataTrackNoun = currentElement.getAttribute('data-track-noun');
    if (!!dataTrackNoun && dataTrackNoun !== 'no-title') {
      existingTrackingAttributes.push(dataTrackNoun);
    }

    const dataTrackVerb = currentElement.getAttribute('data-track-verb');
    if (!!dataTrackVerb && dataTrackVerb !== 'no-title') {
      existingTrackingAttributes.push(dataTrackVerb);
    }

    const dataTrackComponentAttributesSet = currentElement.getAttribute('data-track-component-attributes-set');
    if (
      !!dataTrackComponentAttributesSet &&
      dataTrackComponentAttributesSet === 'true'
    ) {
      aemComponentTracking.checkChildren(currentElement, existingTrackingAttributes);
    } else {
      aemComponentTracking.mergeTrackingAttributes(currentElement, existingTrackingAttributes, parentTrackingAttributes);
    }
  },
  checkChildren: (currentElement, parentTrackingAttributes) => {
    let currentElementChildren;
    parentTrackingAttributes = (!!parentTrackingAttributes && Array.isArray(parentTrackingAttributes)) ? parentTrackingAttributes : [];

    if (!!currentElement) {
      currentElementChildren = currentElement.children;
      if (!!currentElementChildren && currentElementChildren.length > 0) {
        currentElementChildren = [...currentElementChildren];
        if (Array.isArray(currentElementChildren)) {
          currentElementChildren.forEach(currentElementChild => {
            if (
              currentElementChild.hasAttribute('data-track-component-type') ||
              !!['A', 'BUTTON'].includes(currentElementChild.tagName)
            ) {
              aemComponentTracking.getTrackingAttributes(currentElementChild, parentTrackingAttributes);
            } else {
              aemComponentTracking.checkChildren(currentElementChild, parentTrackingAttributes);
            }
          });
        }
        // NOTE: If there were no children, do nothing (stop).
      }
    }
  },
  init: () => {
    if (
      !!window && !!window.document && !!window.document.body &&
      !!window.document.body.querySelector('[data-track-component-type]')
    ) {
      aemComponentTracking.checkChildren(window.document.body);
    }

    const shadowDOMs = _satellite.getVar('shadow doms');
    if (!!shadowDOMs && Array.isArray(shadowDOMs) && shadowDOMs.length > 0) {
      shadowDOMs.forEach((shadowDOM) => {
        if (!!shadowDOM.querySelector('[data-track-component-type]')) {
          aemComponentTracking.checkChildren(shadowDOM);
        }
      });
    }
  },
}

aemComponentTracking.init();</code></pre>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_1440 -->

        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h3 class="heading__title-tag font_size_2">
              <span class="heading__title-tag_title">H3</span>
            </h3>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">
            
            <ol class="main__list font_size_body">
              <li class="content__block_li">
                <p class="main__text font_size_body"><code class="code__snippet font_size_body">Code Snippet</code> goes here.</p>
              </li>
              <li class="content__block_li">
                <p class="main__text font_size_body"><code class="code__name">Code Name</code> goes here.</p>
              </li>
            </ol>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

      </section>
    
    </main>

    <footer class="footer footer_theme_black">

      <div class="content__center content__center_1140">
      
        <div class="footer__icon-row">

          <div class="footer__icon">
            <a href="/" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fas fa-home footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">Home</p>
              </div>
            </a>
          </div>

          <div class="footer__icon">
            <a href="https://www.github.com/toddcf" target="_blank" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fab fa-github footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">GitHub</p>
              </div>
            </a>
          </div>

          <div class="footer__icon">
            <a href="https://www.linkedin.com/in/toddcf" target="_blank" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fab fa-linkedin footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">LinkedIn</p>
              </div>
            </a>
          </div>

          <div class="footer__icon">
            <a href="resume_todd_croak-falen.pdf" target="_blank" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fas fa-file-alt footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">Résumé</p>
                <p class="footer__icon_text font_size_body">(PDF with contact info)</p>
              </div>
            </a>
          </div>
          
        </div> <!-- Close .footer-icon__row -->

        <div class="footer__copyright">
          <p class="footer__copyright_text font_size_body">&copy; Copyright 2016 <span class="currentYear"></span>Todd Croak-Falen</p>
        </div>

      </div> <!-- Close .content__center content__center_1140 -->

    </footer>

  </div> <!-- Close .body__project-container -->

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>

  <!-- Waypoints -->
  <script src="../assets/js/jquery.waypoints.min.js"></script>

  <!-- Prism -->
  <script src="../assets/prism/prism-okaidia-1.29.0.js"></script>
  
  <!-- Custom JavaScript -->
  <script src="../assets/js/global.js"></script>
  <script src="../assets/js/footer-min.js"></script>

</body>

</html>