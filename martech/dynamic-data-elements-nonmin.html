<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Headings -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <!-- Body -->
  <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="../assets/prism/prism-okaidia-1.29.0.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/global-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/text-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/nav-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/heading-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/martech-article-min.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/footer-min.css">
  
  <title>MarTech | Dynamic Data Elements</title>

  <meta name="Author" content="Todd Croak-Falen">
  <meta name="Description" content="MarTech dynamic data elements.">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="../favicon.ico">
  <meta name="msapplication-config" content="browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

</head>

<body class="body line-numbers">

  <div class="body__project-container">

    <nav class="nav">
      <div class="center__1140 nav__flex">
        <a href="/" class="nav__flex_link font_size_1">
          <div class="nav__flex_text"><i class="fas fa-home nav__flex_icon"></i>Home</div>
        </a>
        <a href="../about-me" class="nav__flex_link font_size_1">
          <div class="nav__flex_text"><i class="fas fa-user-circle nav__flex_icon"></i>About Me</div>
        </a>
        <!-- <a href="../resume_todd_croak-falen.pdf" target="_blank" class="nav__flex_link font_size_1">
          <div class="nav__flex_text"><i class="fas fa-file-alt nav__flex_icon"></i>Résumé</div>
        </a> -->
      </div> <!-- Close .nav__flex -->
    </nav>

    <div class="breadcrumbs breadcrumbs_theme_white content-top">
      <div class="content__center content__center_1440">
        <p class="breadcrumbs__text font_size_body"><a class="breadcrumbs__text link link_theme_black" href="/">Home</a> <span class="breadcrumbs__text">></span> <a class="breadcrumbs__text link link_theme_black" href="../martech">MarTech</a> <span class="breadcrumbs__text">></span> <span class="breadcrumbs__text">Dynamic Data Elements</span></p>
      </div> <!-- Close .content__center_1440 -->
    </div>

    <main class="main">

      <header class="header">
        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h1 class="heading__title-tag font_size_4">
              <span class="heading__title-tag_title">Dynamic Data Elements</span>
            </h1>
          </div>
        </div>
        <div class="martech-header__img martech-header__img_leaf-venules"></div>
      </header>

      <section>

        <div class="heading heading_theme_black">
          <div class="heading__title-overflow">
            <h2 class="heading__title-tag font_size_3">
              <span class="heading__title-tag_title">Overview</span>
            </h2>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">
          
            <p class="text__main font_size_body">One issue I faced at my job was that the data layer architecture was inconsistent across the various site sections. I&rsquo;ll anonymize this by pretending I work for an airline; if we wanted to track the name of the destination(s) the user was looking at, there were a few main use cases:</p>

            <ol class="list__main font_size_body">
              <li class="content__block_li">
                <p class="text__main font_size_body">The user is selecting (clicking) a specific destination, such as a filter in the booking flow, or a link to a content page about that destination.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">The user is viewing search results for flights to a single or multiple destinations.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">The user is looking at a content page about the destination itself.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">A known user is just browsing around, but they already have a booking to a specific destination. (Knowing this helps us serve personalized content to them as they browse.)</p>
              </li>
            </ol>

            <p class="text__main font_size_body">Rather than having lots of diffent &lsquo;destination&rsquo; data elements in our codebase, which then have to be mapped into different Launch rules and XDMs, we can create <em>one</em> &lsquo;destination&rsquo; data element that checks for each of these use cases in order of priority.</p>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

      </section>

      <section>

        <div class="heading heading_theme_black">
          <div class="heading__title-overflow">
            <h2 class="heading__title-tag font_size_3">
              <span class="heading__title-tag_title">Use Cases</span>
            </h2>
          </div>
        </div>

        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h3 class="heading__title-tag font_size_2">
              <span class="heading__title-tag_title">Use Case 1: Modern Data Layer</span>
            </h3>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <p class="text__main font_size_body">The modern data layer architecture (which each of our site sections is refactoring to as each gets replatformed) groups the destination <code class="language-javascript">code</code> and <code class="language-javascript">name</code> together within each property, like this:</p>

            <ul class="list__main font_size_body">
              <li class="content__block_li">
                <p class="text__main font_size_body">dataLayer</p>
                <ul class="list__main font_size_body">
                  <li class="content__block_li">
                    <p class="text__main font_size_body">booking</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destination</p>
                        <ul class="list__main font_size_body">
                          <li class="content__block_li">
                            <p class="text__main font_size_body">code</p>
                          </li>
                          <li class="content__block_li">
                            <p class="text__main font_size_body">name</p>
                          </li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                  <li class="content__block_li">
                    <p class="text__main font_size_body">content</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destination</p>
                        <ul class="list__main font_size_body">
                          <li class="content__block_li">
                            <p class="text__main font_size_body">code</p>
                          </li>
                          <li class="content__block_li">
                            <p class="text__main font_size_body">name</p>
                          </li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                  <li class="content__block_li">
                    <p class="text__main font_size_body">search</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destination</p>
                        <ul class="list__main font_size_body">
                          <li class="content__block_li">
                            <p class="text__main font_size_body">code</p>
                          </li>
                          <li class="content__block_li">
                            <p class="text__main font_size_body">name</p>
                          </li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h3 class="heading__title-tag font_size_2">
              <span class="heading__title-tag_title">Use Case 2: Legacy Data Layer</span>
            </h3>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <p class="text__main font_size_body">Older site sections use a flatter data layer architecture, which does <em>not</em> nest the <code class="language-javascript">code</code> and <code class="language-javascript">name</code> together under one <code class="language-javascript">destination</code> property:</p>

            <ul class="list__main font_size_body">
              <li class="content__block_li">
                <p class="text__main font_size_body">dataLayer</p>
                <ul class="list__main font_size_body">
                  <li class="content__block_li">
                    <p class="text__main font_size_body">booking</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destination</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destinationCode</p>
                      </li>
                    </ul>
                  </li>
                  <li class="content__block_li">
                    <p class="text__main font_size_body">content</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destination</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destinationCode</p>
                      </li>
                    </ul>
                  </li>
                  <li class="content__block_li">
                    <p class="text__main font_size_body">search</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destination</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">destinationCode</p>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h3 class="heading__title-tag font_size_2">
              <span class="heading__title-tag_title">Use Case 3: Data Attributes (Clicks)</span>
            </h3>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <p class="text__main font_size_body">When we began implementing AEP as well, we created one global XDM that could be used for both clicks and page/route loads. The reasoning for this was twofold:</p>

            <ol class="list__main font_size_body">
              <li class="content__block_li">
                <p class="text__main font_size_body">To be D.R.Y.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">To ensure that the schema architecture is <em>identical</em> in all circumstances, preventing batch ingestion failures.</p>
              </li>
            </ol>

            <p class="text__main font_size_body">Therefore, these same dynamic data elements required logic that would first check if the rule-triggering event contained data attributes.</p>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

      </section>

      <section>

        <div class="heading heading_theme_black">
          <div class="heading__title-overflow">
            <h2 class="heading__title-tag font_size_3">
              <span class="heading__title-tag_title">Syntax</span>
            </h2>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <p class="text__main font_size_body">Here is the actual programming. (Scroll down for a description of how it works.)</p>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center_700 -->

        <div class="content__center content__center_1140">

  <pre class="code__block"><code class="language-javascript">let destinationName;
let destinationNameArr;
let destinationNameMap;

const clickAttributes = (!!event && !!event.detail) ? event.detail : '';

if (
  !!clickAttributes &&
  !!clickAttributes['data-track-noun'] &&
  clickAttributes['data-track-noun'] === 'filter-destination' &&
  !!clickAttributes['data-track-name']
) {
  // Booking Flow Destination Filter Clicks (future-proofed version):
  destinationName = clickAttributes['data-track-name'];
} else if (
  !!clickAttributes &&
  !!clickAttributes['data-track-noun'] &&
  clickAttributes['data-track-noun'] === 'search-filter'
) {
  // Do nothing.
} else if (!!window.dataLayer) {
  if (
    !!window.dataLayer.booking &&
    typeof window.dataLayer.booking.destination === 'object' &&
    typeof window.dataLayer.booking.destination.name === 'string'
  ) {
    destinationName = window.dataLayer.booking.destination.name;
  } else if (
    !!window.dataLayer.booking &&
    typeof window.dataLayer.booking.destination === 'string'
  ) {
    destinationName = window.dataLayer.booking.destination;
  } else if (
    !!window.dataLayer.search &&
    !!window.dataLayer.search.destination &&
    Array.isArray(window.dataLayer.search.destination)
  ) {
    destinationNameArr = window.dataLayer.search.destination;
    destinationNameMap = destinationNameArr.map(destination => destination.name);
    if (!!destinationNameMap && Array.isArray(destinationNameMap)) {
      destinationName = destinationNameMap.toString();
    }
  } else if (
    !!window.dataLayer.search &&
    typeof window.dataLayer.search.destination === 'string'
  ) {
    destinationName = window.dataLayer.search.destination;
  } else if (
    !!window.dataLayer.content &&
    typeof window.dataLayer.content.destination === 'object' &&
    typeof window.dataLayer.content.destination.name === 'string'
  ) {
    destinationName = window.dataLayer.content.destination.name;
  } else if (
    !!window.dataLayer.content &&
    typeof window.dataLayer.content.destination === 'string'
  ) {
    destinationName = window.dataLayer.content.destination;
  }
}

if (
  !!destinationName &&
  typeof destinationName === 'string' &&
  destinationName !== 'NA'
) {
  return destinationName;
}</code></pre>

        </div> <!-- Close .content__center content__center_1140 -->

        <div class="heading heading_theme_clear">
          <div class="heading__title-overflow">
            <h3 class="heading__title-tag font_size_2">
              <span class="heading__title-tag_title">Explanation</span>
            </h3>
          </div>
        </div>

        <div class="content__center content__center_700">

          <div class="content__block">

            <ul class="list__main font_size_body">
              <li class="content__block_li">
                <p class="text__main font_size_body">Line 1: Declare the variable where the value will be stored. For AEP purposes, do not set any default value. (If there is no value, we want this data element to return <code class="language-javascript">undefined</code> so that its property is omitted from the XDM. If it defaults to <code class="language-javascript">''</code> or <code class="language-javascript">null</code>, the property will be added to the XDM, which could result in a batch ingestion failure.)</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">Lines 2 - 3: Declare the variables that will be used to handle array use cases later in this flow.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">Line 5: If the rule that invokes this data element has been triggered by a click, an object will have been passed into it. That object will be the clicked element. We store it in the <code class="language-javascript">clickAttributes</code> variable. (And if the event was not a click, we default this variable to an empty string so that its condition will not be met later in our logic.)</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">Lines 7 - 14: The first thing we check are the click use cases. Some of our pages follow the new and improved convention of having <code class="language-html">data-track-noun="filter-destination"</code> attributes. If a clicked element has this attribute, we&rsquo;ll want to pull the value from its <code class="language-html">data-track-name</code> attribute. We check that both exist before attempting to do this.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">Lines 15 - 20: Some of our pages have search filters whose data attributes have <em>not</em> been updated to the new and improved convention described above. If this is the case, they will have a legacy attribute called <code class="language-html">data-track-noun="search-filter"</code>. If so, they do <em>not</em> also contain a <code class="language-html">data-track-name</code> attribute, so we can&rsquo;t pull the destination name from it. Instead, we keep a condition here that <em>will be met but do nothing</em>. This prevents clicks on these legacy elements from falling back to the values in the data layer further down the flow &mdash; which would not accurately reflect what was clicked.</p>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">Lines 21 - 60: We now enter the data layer conditions.</p>
                <ul class="list__main font_size_body">
                  <li class="content__block_li">
                    <p class="text__main font_size_body">Lines 22 - 32: First we check if a <code class="language-javascript">booking</code> destination exists.</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Lines 22 - 27: We first look for the <code class="language-javascript">booking</code> property in the <em>modern</em> data layer architecture.</p>
                        <ul class="list__main font_size_body">
                          <li class="content__block_li">
                            <p class="text__main font_size_body">Line 24: Rather than just checking to see if <code class="language-javascript">window.dataLayer.booking.destination</code> exists, we confirm that it is an object. This is because if our code was reading the legacy data layer, this condition would be met even though it is only a string. If that were the case, attempting to check <code class="language-javascript">window.dataLayer.booking.destination.name</code> on the next line would throw an error.</p>
                          </li>
                          <li class="content__block_li">
                            <p class="text__main font_size_body">Lines 25 - 27: Having confirmed that <code class="language-javascript">window.dataLayer.booking.destination</code> is an object, we now confirm that <code class="language-javascript">window.dataLayer.booking.destination.name</code> is a string. If so, we store it in our <code class="language-javascript">destinationName</code> variable.</p>
                          </li>
                        </ul>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Lines 28 - 32: If the destination name was not found in the <em>modern</em> data layer architecture, we check the <em>legacy</em> data layer architecture next.</p>
                      </li>
                    </ul>
                  </li>
                  <li class="content__block_li">
                    <p class="text__main font_size_body">Lines 33 - 47: If the destination name was not found in the <code class="language-javascript">booking</code> properties, it&rsquo;s time to check the <code class="language-javascript">search</code> properties &mdash; first in the modern architecture, then in the legacy architecture.</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Lines 33 - 36: The modern data layer&rsquo;s <code class="language-javascript">search</code> property is a little more complex because it is an array. The user has the ability to search for multiple destinations at a time. This first condition includes validation to confirm that we are indeed dealing with an array before we try to run methods on a property that will throw an error if it&rsquo;s not an array.</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Line 38: Store the array in <code class="language-javascript">destinationNameArr</code>. (Each item in the array will contain both a destination <code class="language-javascript">name</code> and a destination <code class="language-javascript">id</code> (code).)</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Line 39: Map each <code class="language-javascript">name</code> value into a new array, and store it in <code class="language-javascript">destinationNameMap</code>.</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Lines 40 -42: We do another quick validation check to make sure we aren&rsquo;t pulling the wrong data type, and then we convert the array into a string.</p>
                      </li>
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Lines 44 - 47: On the other hand, if we are working with the legacy data layer, the list of destination names will already be a string. And they will not include destination codes.</p>
                      </li>
                    </ul>
                  </li>
                  <li class="content__block_li">
                    <p class="text__main font_size_body">Lines 48 - 59: If the destination name was not found in <code class="language-javascript">booking</code> or <code class="language-javascript">search</code>, next check <code class="language-javascript">content</code>. As always, we check for the modern data layer first, and the legacy data layer second.</p>
                    <ul class="list__main font_size_body">
                      <li class="content__block_li">
                        <p class="text__main font_size_body">Lines 50 - 51: It is important to confirm that <code class="language-javascript">dataLayer.content.destination</code> is an object before considering it to be a match. This is because the legacy data layer also contains this exact same property, only it is a string and contains the final value. If this is the case and we next try to run some dot notation on it (on line 51), it will throw an error.</p>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li class="content__block_li">
                <p class="text__main font_size_body">Lines 63 - 65: To prevent batch ingestion failures in AEP, we make sure no <code class="language-javascript">null</code> values, empty strings, or <code class="language-javascript">'NA'</code> default values from the data layer get passed through. Done!</p>
              </li>
            </ul>

          </div> <!-- Close .content__block -->

        </div> <!-- Close .content__center content__center_700 -->

      </section>
    
    </main>

    <footer class="footer footer_theme_black">

      <div class="center__1140">
      
        <div class="footer__icon-row">

          <div class="footer__icon">
            <a href="/" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fas fa-home footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">Home</p>
              </div>
            </a>
          </div>

          <div class="footer__icon">
            <a href="https://www.github.com/toddcf" target="_blank" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fab fa-github footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">GitHub</p>
              </div>
            </a>
          </div>

          <div class="footer__icon">
            <a href="https://www.linkedin.com/in/toddcf" target="_blank" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fab fa-linkedin footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">LinkedIn</p>
              </div>
            </a>
          </div>

          <div class="footer__icon">
            <a href="resume_todd_croak-falen.pdf" target="_blank" class="footer__icon_link">
              <div class="footer__icon_link-content">
                <i class="fas fa-file-alt footer__icon_icon"></i>
                <p class="footer__icon_text font_size_body">Résumé</p>
                <p class="footer__icon_text font_size_body">(PDF with contact info)</p>
              </div>
            </a>
          </div>
          
        </div> <!-- Close .footer-icon__row -->

        <div class="footer__copyright">
          <p class="footer__copyright_text font_size_body">&copy; Copyright 2016 <span class="currentYear"></span>Todd Croak-Falen</p>
        </div>

      </div> <!-- Close .center__1140 -->

    </footer>

  </div> <!-- Close .body__project-container -->

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>

  <!-- Waypoints -->
  <script src="../assets/js/jquery.waypoints.min.js"></script>

  <!-- Prism -->
  <script src="../assets/prism/prism-okaidia-1.29.0.js"></script>
  
  <!-- Custom JavaScript -->
  <script src="../assets/js/global-min.js"></script>
  <script src="../assets/js/footer-min.js"></script>

</body>

</html>