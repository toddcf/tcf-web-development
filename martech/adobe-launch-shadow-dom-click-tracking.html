<!doctype html><html lang=en><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link href=https://use.fontawesome.com/releases/v5.8.1/css/all.css rel=stylesheet crossorigin=anonymous integrity=sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel=stylesheet><link href=../assets/prism/prism-okaidia-1.29.0.css rel=stylesheet><link href=../assets/css/global-min.css rel=stylesheet><link href=../assets/css/text-min.css rel=stylesheet><link href=../assets/css/nav-min.css rel=stylesheet><link href=../assets/css/headings-min.css rel=stylesheet><link href=../assets/css/martech-article-min.css rel=stylesheet><link href=../assets/css/footer-min.css rel=stylesheet><title>MarTech | Adobe Launch Shadow DOM Click Tracking</title><meta content="Todd Croak-Falen" name=Author><meta content="MarTech Adobe Launch shadow DOM click tracking." name=Description><link href=../apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=../favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=../favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=../manifest.json rel=manifest><link href=../safari-pinned-tab.svg rel=mask-icon color=#5bbad5><link href=../favicon.ico rel="shortcut icon"><meta content=browserconfig.xml name=msapplication-config><meta content=#ffffff name=theme-color><body class="body line-numbers"><div class=body__project-container><nav class=nav><div class="content__center content__center_1140 nav__flex"><a class="font_size_1 nav__flex_link" href=/ ><div class=nav__flex_text><i class="fas fa-home nav__flex_icon"></i>Home</div></a><a class="font_size_1 nav__flex_link" href=../about-me><div class=nav__flex_text><i class="fas nav__flex_icon fa-user-circle"></i>About Me</div></a></div></nav><main class="content-top main"><header class=header><div class="heading heading_theme_clear"><div class=heading__title-overflow><h1 class="heading__title-tag font_size_4"><span class=heading__title-tag_title>Adobe Launch Shadow DOM Click Tracking</span></h1></div></div><div class="martech-header__img martech-header__img_wild-water"></div></header><section><div class="heading heading_theme_black"><div class=heading__title-overflow><h2 class="heading__title-tag font_size_3"><span class=heading__title-tag_title>Overview</span></h2></div></div><div class="content__center content__center_700"><div class=content__block><p class="font_size_body main__text">When the company I was working for introduced a new global header and footer that existed in the shadow DOM, I faced a new challenge:<p class="font_size_body main__text">It turned out that Adobe Launch did not automatically detect clicks inside of shadow DOMs. We already had a global rule in Launch to track clicks and events. (Called <code class=code__name>Global | Set Variables | Clicks or Events #25</code> — see my article on <a class="link link_theme_black" href=adobe-launch-global-clicks-or-events-tracking>Adobe Launch Global Clicks or Events Tracking</a> for details on how it works.)<p class="font_size_body main__text">But it wasn’t getting triggered. Therefore, I had to come up with a custom code workaround to detect shadow DOM clicks manually.<p class="font_size_body main__text">The overall architecture I came up with is:<ol class="font_size_body main__list"><li class=content__block_li><p class="font_size_body main__text">When the page loads, I crawl it and collect any shadow DOMs that exist.<li class=content__block_li><p class="font_size_body main__text">For each shadow DOM that is found, I attach a ‘click’ event listener to its shadowRoot.<li class=content__block_li><p class="font_size_body main__text">If a click is detected by this event listener, my code determines what the clicked element was and standardizes it to the type of object that the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule (for regular DOM clicks) expects.<li class=content__block_li><p class="font_size_body main__text">Then I manually trigger the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule, and send it the standardized object that was created by my custom code.</ol><p class="font_size_body main__text">The custom code is explained in detail below.</div></div></section><section><div class="heading heading_theme_black"><div class=heading__title-overflow><h2 class="heading__title-tag font_size_3"><span class=heading__title-tag_title>Shadow DOM Data Element (‘shadow doms’)</span></h2></div></div><div class="content__center content__center_700"><div class=content__block><p class="font_size_body main__text">I figured that I might want the ability to crawl the page for shadow DOMs in other applications, too. So rather than putting the custom code directly in my Shadow DOM rule in Adobe Launch, I put it in a data element that could be referenced from anywhere.<p class="font_size_body main__text">I named this data element <code class=code__name>shadow doms</code>, and it only contains one line of code:<pre class=code__block><code class=language-javascript>return [...document.getElementsByTagName('*')].filter(tag => !!tag.shadowRoot);</code></pre></div></div><div class="heading heading_theme_clear"><div class=heading__title-overflow><h3 class="heading__title-tag font_size_2"><span class=heading__title-tag_title>Explanation</span></h3></div></div><div class="content__center content__center_700"><div class=content__block><ol class="font_size_body main__list"><li class=content__block_li><p class="font_size_body main__text"><code class="font_size_body code__snippet">document.getElementsByTagName('*')</code> gets all tags on the page.<li class=content__block_li><p class="font_size_body main__text">However, that returns an HTMLCollection. So I wrapped it inside a spread operator <code class=code__snippet>[...]</code> to convert it to an array.<li class=content__block_li><p class="font_size_body main__text">Now that I had an array, I could call the <code class=code__name>.filter</code> method on it.<li class=content__block_li><p class="font_size_body main__text"><code class=code__snippet>.filter(tag => !!tag.shadowRoot)</code> checks each tag in the array. If a tag contains a <code class=code__name>shadowRoot</code>, then that tag represents a shadow DOM, and the filter will include it. (If not, the filter will ignore that tag.)<li class=content__block_li><p class="font_size_body main__text">Last but not least, I <code class=code__snippet>return</code> all of this, or else my data element will do all this work but not spit out the results at the end.</ol><p class="font_size_body main__text">Now, any time I run <code class=code__snippet>_satellite.getVar('shadow doms')</code>, I receive an array containing all the shadow DOM tags that were filtered out of the entire page. (If none were found, it will return an empty array.)</div></div></section><section><div class="heading heading_theme_black"><div class=heading__title-overflow><h2 class="heading__title-tag font_size_3"><span class=heading__title-tag_title>Shadow DOM “Add Event Listener” Rule</span></h2></div></div><div class="content__center content__center_700"><div class=content__block><p class="font_size_body main__text">Once I had my <code class=code__snippet>shadow doms</code> data element working, I was ready to use it in an Adobe Launch rule. I created a rule containing custom code that, if it finds any shadow DOMs on the page, attaches a ‘click’ listener to each one. I named it <code class=code__name>Global | Add Shadow DOM Event Listeners</code>.<p class="font_size_body main__text">First, the full code block for context. (Scroll past it for a breakdown of what each part does.)<pre class=code__block><code class=language-javascript>const shadowDOMs = _satellite.getVar('shadow doms');

const shadowClicks = (e) => {
  const clickData = {
    shadowClick: true,
    clickedElement: '',
  };
  
  if (!!e.target) {
    if (e.target instanceof SVGElement) {
      if (!!e.target.getAttribute('d')) {
        // Path elements *inside* SVG tags:
        clickData.clickedElement = e.target.parentNode.parentNode;
      } else {
        // SVG tags themselves:
        clickData.clickedElement = e.target.parentNode;
      }
    } else {
      // All other clicks (non-SVG):
      clickData.clickedElement = e.target;
    }
  }
  
  if (!!clickData.clickedElement) {
    _satellite.track('set-global-click-or-event-variables', clickData);
    _satellite.track('send-global-click-or-event-beacon');
  }
}

if (!!shadowDOMs && Array.isArray(shadowDOMs) && shadowDOMs.length > 0) {
  shadowDOMs.forEach(shadowDOM => {
    shadowDOM.shadowRoot.addEventListener('click', shadowClicks);
  });
}</code></pre></div></div><div class="heading heading_theme_clear"><div class=heading__title-overflow><h3 class="heading__title-tag font_size_2"><span class=heading__title-tag_title>Explanation</span></h3></div></div><div class="content__center content__center_700"><div class=content__block><p class="font_size_body main__text">First, a quick note: I programmed the rule itself to be triggered on every page/route load.<ul class="font_size_body main__list"><li class=content__block_li><p class="font_size_body main__text">Line 1: The first thing the custom code inside the rule does is grab the <code class=code__name>shadow doms</code> data element and store it in a variable called <code class=code__name>shadowDOMs</code>.<li class=content__block_li><p class="font_size_body main__text">Line 3: Next, I created a function called <code class=code__name>shadowClicks</code> that gets triggered whenever a ‘click’ event is detected in a shadow DOM. It takes in the parameter <code class=code__name>(e)</code> for the click event.<li class=content__block_li><p class="font_size_body main__text">Line 4: The first thing this function does is create an object called <code class=code__name>clickData</code>. This object will later be passed to our <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule. It simulates the clicked element as it would have occurred in the regular DOM.<li class=content__block_li><p class="font_size_body main__text">Line 5: The <code class=code__name>clickData</code> object contains the property:<pre><code class=code__snippet>shadowClick: true</code></pre><p class="font_size_body main__text">(Note that <code class=code__name>true</code> is a Boolean, not a string.)<p class="font_size_body main__text">This flag is important when this object is later passed to the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule. It allows me to differentiate between regular DOM clicks and shadow DOM clicks. But for now, let’s not go down this rabbit hole.<li class=content__block_li><p class="font_size_body main__text">Line 6: The next property that the <code class=code__name>clickData</code> object contains is:<pre><code class=code__snippet>clickedElement: ''</code></pre><p class="font_size_body main__text">At the beginning, it is defaulted it to an empty string. But after the rest of the logic in this function determines what exactly should be considered the clicked element, that element will be stored here.<li class=content__block_li><p class="font_size_body main__text">Line 9: Next is the logic that determines which element in the shadow DOM got clicked. This typically involves the <code class=code__name>target</code> in the click event (the <code class=code__name>e</code> parameter this function takes in). Therefore, the first thing I did was add some validation to make sure that <code class=code__name>e.target</code> even exists.<pre><code class=code__snippet>if (!!e.target) {}</code></pre><li class=content__block_li><p class="font_size_body main__text">Lines 10 - 17: I found out the hard way that if the clicked element is an SVG, the <code class=code__name>clickData</code> object that you pass to your <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule is going to be a mess. So I accounted for this specifically as follows:<ul class="font_size_body main__list"><li class=content__block_li><p class="font_size_body main__text">Lines 11 - 13: The user may have clicked on the SVG tag itself, or they may have clicked on the path elements <em>inside</em> the SVG tag. This first code block handles clicks on path elements.<p class="font_size_body main__text">Note that this condition must be nested <em>inside</em> the <code class=code__name>instanceof SVGElement</code> condition, as that will also be true.<p class="font_size_body main__text">This code block looks <em>two</em> parentNodes up from the path element, then stores the result in the <code class=code__name>clickData</code> object.<li class=content__block_li><p class="font_size_body main__text">Lines 14 - 16: The <code class=code__name>else</code> condition accounts for clicks directly on the SVG tags. For this use case, we only have to go up <em>one</em> <code class=code__name>parentNode</code>.</ul><li class=content__block_li><p class="font_size_body main__text">Line 18: That’s it for SVGs. I now exit the SVG condition(s) and account for all other (non-SVG) clicks. This use case is much simpler — it just grabs <code class=code__name>e.target</code> and stores it in the <code class=code__name>clickData</code> object.<li class=content__block_li><p class="font_size_body main__text">Line 24: Now the clicked element (if it exists) has been selected and my code is ready to pass it to the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule. Once again, for safety, I start with some validation to confirm that a clicked element was found before I go so far as to send it:<pre><code class=code__snippet>if (!!clickData.clickedElement) {}</code></pre><li class=content__block_li><p class="font_size_body main__text">Line 25: Inside this condition, I first trigger the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule that sets variables, and then I pass the entire <code class=code__name>clickData</code> object into it.<p class="font_size_body main__text">The <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule will take it from here. (See my article on <a class="link link_theme_black" href=adobe-launch-global-clicks-or-events-tracking>Adobe Launch Global Clicks or Events Tracking</a> for how that works.)<li class=content__block_li><p class="font_size_body main__text">Line 26: Immediately after that, I trigger the <code class=code__name>Global | Send, Clear Variables | Clicks or Events #100</code> rule that sends the beacon and clears the variables.<p class="font_size_body main__text">(Once again, see my article on <a class="link link_theme_black" href=adobe-launch-global-clicks-or-events-tracking>Adobe Launch Global Clicks or Events Tracking</a> for an explanation on this architecture.)<li class=content__block_li><p class="font_size_body main__text">Lines 30 - 34: That’s it for the function. But it still needed an event listener to trigger it. The listener is wrapped in some validation to make sure that <code class=code__name>shadowDOMs</code> exists, that it is an array, and that this array contains at least one item. (Remember the <code class=code__name>shadow doms</code> data element I stored in a variable back on line 1? This is where that variable starts getting used.)<p class="font_size_body main__text">This validation is important because if no shadow DOMs exist on the page . . . I don’t want the rest of this code block to execute and start throwing errors.<li class=content__block_li><p class="font_size_body main__text">Line 31: Once I’m certain that <code class=code__name>shadowDOMs</code> is an array containing at least one item, I am safe to run the <code class=code__name>.forEach</code> method on it.<li class=content__block_li><p class="font_size_body main__text">Line 32: ‘For each’ shadow DOM in the array, I attach a ‘click’ listener to its <code class=code__name>shadowRoot</code>. And when a click on this <code class=code__name>shadowRoot</code> is detected, all it has to do is invoke the <code class=code__name>shadowClicks</code> function.</ul></div></div><div class="heading heading_theme_black"><div class=heading__title-overflow><h2 class="heading__title-tag font_size_3"><span class=heading__title-tag_title>Summary</span></h2></div></div><div class="content__center content__center_700"><div class=content__block><p class="font_size_body main__text">Every time a page/route loads, the <code class=code__name>Global | Add Shadow DOM Event Listeners</code> rule fires. It runs the <code class=code__name>shadow doms</code> data element. If that data element returns at least one shadow DOM, the rule sets up a click listener on each of those shadow DOMs. Then, when a shadow DOM click is detected, it will capture the data from the clicked element and pass it over to the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule, simulating a regular-DOM click.<p class="font_size_body main__text">See my <a class="link link_theme_black" href=adobe-launch-global-clicks-or-events-tracking>Adobe Launch Global Clicks or Events Tracking</a> article for details on how the <code class=code__name>Global | Set Variables | Clicks or Events #25</code> rule handles the rest.</div></div></section></main><footer class="footer footer_theme_black"><div class="content__center content__center_1140"><div class=footer__icon-row><div class=footer__icon><a class=footer__icon_link href=/ ><div class=footer__icon_link-content><i class="fas fa-home footer__icon_icon"></i><p class="font_size_body footer__icon_text">Home</div></a></div><div class=footer__icon><a class=footer__icon_link href=https://www.github.com/toddcf target=_blank><div class=footer__icon_link-content><i class="footer__icon_icon fab fa-github"></i><p class="font_size_body footer__icon_text">GitHub</div></a></div><div class=footer__icon><a class=footer__icon_link href=https://www.linkedin.com/in/toddcf target=_blank><div class=footer__icon_link-content><i class="footer__icon_icon fab fa-linkedin"></i><p class="font_size_body footer__icon_text">LinkedIn</div></a></div><div class=footer__icon><a class=footer__icon_link href=resume_todd_croak-falen.pdf target=_blank><div class=footer__icon_link-content><i class="fas footer__icon_icon fa-file-alt"></i><p class="font_size_body footer__icon_text">Résumé<p class="font_size_body footer__icon_text">(PDF with contact info)</div></a></div></div><div class=footer__copyright><p class="font_size_body footer__copyright_text">© Copyright 2016 <span class=currentYear></span>Todd Croak-Falen</div></div></footer></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js crossorigin=anonymous integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo></script><script src=../assets/js/jquery.waypoints.min.js></script><script src=../assets/prism/prism-okaidia-1.29.0.js></script><script src=../assets/js/global.js></script><script src=../assets/js/footer-min.js></script>